<script>
  function toggleDetails(userId) {
    const detailsRow = document.getElementById('details-' + userId);
    if (detailsRow.style.display === 'none') {
      detailsRow.style.display = 'table-row';
    } else {
      detailsRow.style.display = 'none';
    }
  }
</script>

<div style="display: flex; flex-direction: column; gap: 20px; max-width: 100%;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <h2 style="margin: 0;">ğŸ‘¤ Users</h2>
    <span>Data</span>
  </div>

  <div style="display: flex; flex-direction: column; gap: 20px; max-width: 100%;">
    <div style="border-style: dashed; border-radius: 5px; padding: 20px; width: 100%; display: flex; flex-direction: column; gap: 10px;">
      <div style="display: flex; flex-direction: column; gap: 5px; overflow-x: auto;">

        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
          <thead>

            <tr style="border-bottom: 1px dashed #ddd;">
              <th style="text-align: left; padding: 8px;">ğŸ·ï¸ ID</th>
              <th style="text-align: left; padding: 8px;">ğŸ‘¤ User</th>
              <th style="text-align: left; padding: 8px;">â±ï¸ Timezone</th>
              <th style="text-align: left; padding: 8px;">âš ï¸ Limits</th>
              <th style="text-align: left; padding: 8px;">ğŸ—“ï¸ Created At</th>
              <th style="text-align: left; padding: 8px;">ï¸âš¡ï¸ Actions</th>
            </tr>
          </thead>

          <tbody>
            <% users.forEach(user => { %>
              <tr style="border-bottom: 1px dashed #ddd;">
                <td style="padding: 8px;"><%= user.id %></td>

                <td style="padding: 8px; display: flex; flex-direction: column;">
                  <span><%= user.is_admin ? 'â­ï¸' : '' %> <%= user.username %></span>
                  <a href="mailto:<%= user.email %>"><%= user.email %></a>
                </td>

                <td style="padding: 8px;"><%= user.timezone %></td>

                <td style="padding: 8px;">
                  <span><strong>Max Apps:</strong> <%= user.max_apps_allowed %></span>
                  <div style="display: flex; gap: 5px;">
                    <span><strong>Max Exports:</strong> <%= user.max_export_count_allowed%></span>
                    <span>/</span>
                    <span><strong>Exported:</strong> <%= user.export_count %></span>
                  </div>
                </td>

                <td style="padding: 8px;"><%= user.created_at %></td>

                <td style="padding: 8px; display: flex; align-items: center; gap: 10px;">
                  <button class="no-style-btn" onclick="toggleDetails(<%= user.id %>)">view</button>
                  <button class="no-style-btn" onclick="document.getElementById(`edit-user-<%= user.id %>-modal`).showModal()">ï¸edit</button>
                  <dialog id="edit-user-<%= user.id %>-modal">
                    <h2>ğŸ“± Edit User <%= user.name %></h2>
                    <form method="POST" action="/admin/users/<%= user.id %>">
                      <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />

                      <pre><%= JSON.stringify(user, null, 2) %></pre>

                      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="this.closest('dialog').close()">âŒ Cancel</button>
                        <button type="submit">ï¸ğŸ”„ Update</button>
                      </div>
                    </form>
                  </dialog>
                </td>

              </tr>

              <tr id="details-<%= user.id %>" style="display: none;">

                <td colspan="8" style="padding: 0; border-bottom: 1px dashed #ddd;">
                  <div style="padding: 20px; background-color: #f9f9f9;">
                    <table style="width: 100%; border-collapse: collapse;">

                      <thead>
                        <tr style="border-bottom: 1px dashed #ddd;">
                          <th style="text-align: left; padding: 8px;">ğŸ·ï¸ ID</th>
                          <th style="text-align: left; padding: 8px;">ğŸ“± App</th>
                          <th style="text-align: left; padding: 8px;">ğŸ”” Alert Info</th>
                          <th style="text-align: left; padding: 8px;">ğŸ—“ï¸ Created At</th>
                          <th style="text-align: left; padding: 8px;">ğŸš¦ Status</th>
                          <th style="text-align: left; padding: 8px;">ï¸ï¸âš¡ï¸ Actions</th>
                        </tr>
                      </thead>

                      <tbody>
                        <% user.apps?.forEach(app => { %>
                          <tr style="height: 100%; border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px;"><%= app.id %></td>

                            <td style="padding: 8px; display: flex; flex-direction: column;">
                              <a href="/apps/<%= app.id %>"><%= app.name %></a>
                              <% if (app.url) { %>
                                <a href="<%= app.url %>" target="_blank">ğŸŒ <%= app.url %></a>
                              <% } %>
                              <% if (app.description) { %>
                                <span>ğŸ“ <%= app.description %></span>
                              <% } %>
                            </td>

                            <td style="padding: 8px;">
                              <div style="display: flex; flex-direction: column; gap: 5px;">
                                <span><strong>Allowed:</strong> <%= app.max_monthly_alerts_allowed %></span>
                                <div style="display: flex; gap: 5px;">
                                  <span><strong>Threshold:</strong> <%= app.user_monthly_limit_threshold || 'N/A' %></span>
                                  <span>/</span>
                                  <span><strong>Sent:</strong> <%= app.alerts_sent_this_month %></span>
                                </div>
                                <span><strong>Reset Date:</strong> <%= app.alerts_reset_date %></span>
                              </div>
                            </td>

                            <td style="padding: 8px;"><%= app.created_at %></td>

                            <td style="padding: 8px;"><%= app.is_active ? 'ğŸŸ¢' : 'ğŸ”´' %></td>

                            <td style="padding: 8px;">
                              <button class="no-style-btn" onclick="document.getElementById(`edit-user-<%= user.id %>-app-<%= app.id %>-modal`).showModal()">ï¸edit</button>

                              <dialog id="edit-user-<%= user.id %>-app-<%= app.id %>-modal" style="width: 600px; display: flex; flex-direction: column; gap: 20px;">
                                <h2>ğŸ“± Edit App <%= app.name %></h2>

                                <form method="POST" action="/admin/users/<%= user.id %>/apps/<%= app.id %>" style="display: flex; flex-direction: column; gap: 10px;">
                                  <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />

                                  <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <label for="name">ğŸ”¤ Name<span style="color: red;">*</span></label>
                                    <input type="text" id="name" name="name" value="<%= app.name %>" required>
                                  </div>

                                  <div>
                                    <label for="is_active">ğŸš¦ Status</label>
                                    <input type="checkbox" id="is_active" name="is_active" <%= app.is_active ? 'checked' : '' %>>
                                  </div>

                                  <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <label for="url">ğŸŒ Url</label>
                                    <input type="url" id="url" name="url" value="<%= app.url %>" required>
                                  </div>

                                  <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <label for="description">ğŸ“ Description</label>
                                    <textarea name="description" id="description"><%= app.description %></textarea>
                                  </div>

                                  <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <label for="user_monthly_limit_threshold">ğŸ”¢ Alert Threshold</label>
                                    <input type="number" id="user_monthly_limit_threshold" name="user_monthly_limit_threshold" value="<%= app.user_monthly_limit_threshold %>" min="1" max="<%= app.max_monthly_alerts_allowed %>">
                                    <small style="color: #666;">Set a threshold to receive notifications when your alert count reaches this number. Leave blank for no threshold.</small>
                                  </div>

                                  <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                                    <button type="button" onclick="this.closest('dialog').close()">âŒ Cancel</button>
                                    <button type="submit">ï¸ğŸ”„ Update</button>
                                  </div>
                                </form>
                              </dialog>
                            </td>

                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>
