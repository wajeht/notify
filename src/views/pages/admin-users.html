<script>
  function toggleDetails(userId) {
    const detailsRow = document.getElementById('details-' + userId);
    if (detailsRow.style.display === 'none') {
      detailsRow.style.display = 'table-row';
    } else {
      detailsRow.style.display = 'none';
    }
  }
</script>

<div style="display: flex; flex-direction: column; gap: 20px; max-width: 100%;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <h2 style="margin: 0;">üë§ Users</h2>
    <span>Data</span>
  </div>

  <div style="display: flex; flex-direction: column; gap: 20px; max-width: 100%;">
    <div style="border-style: dashed; border-radius: 5px; padding: 20px; width: 100%; display: flex; flex-direction: column; gap: 10px;">
      <div style="display: flex; flex-direction: column; gap: 5px; overflow-x: auto;">

        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
          <thead>
            <tr style="border-bottom: 1px dashed #ddd;">
              <th style="text-align: left; padding: 8px;">üè∑Ô∏è ID</th>
              <th style="text-align: left; padding: 8px;">üë§ User</th>
              <th style="text-align: left; padding: 8px;">‚è±Ô∏è Timezone</th>
              <th style="text-align: left; padding: 8px;">‚ö†Ô∏è Limits</th>
              <th style="text-align: left; padding: 8px;">üóìÔ∏è Created At</th>
              <th style="text-align: left; padding: 8px;">Ô∏è‚ö°Ô∏è Actions</th>
            </tr>
          </thead>

          <tbody>
            <% users.forEach(user => { %>
              <tr style="border-bottom: 1px dashed #ddd;">
                <td style="padding: 8px;"><%= user.id %></td>
                <td style="padding: 8px; display: flex; flex-direction: column;">
                  <span><%= user.is_admin ? '‚≠êÔ∏è' : '' %> <%= user.username %></span>
                  <a href="mailto:<%= user.email %>"><%= user.email %></a>
                </td>
                <td style="padding: 8px;"><%= user.timezone %></td>
                <td style="padding: 8px;">
                  <span><strong>Max Apps:</strong> <%= user.max_apps_allowed %></span>
                  <div style="display: flex; gap: 5px;">
                    <span><strong>Max Exports:</strong> <%= user.max_export_count_allowed%></span>
                    <span>/</span>
                    <span><strong>Exported:</strong> <%= user.export_count %></span>
                  </div>
                </td>
                <td style="padding: 8px;"><%= user.created_at %></td>
                <td style="padding: 8px;">
                  <button class="no-style-btn" onclick="toggleDetails(<%= user.id %>)">view</button>
                  <button class="no-style-btn" onclick="document.getElementById(`edit-user-<%= user.id %>-modal`).showModal()">Ô∏èedit</button>
                  <dialog id="edit-user-<%= user.id %>-modal">
                    <h2>üì± Edit User <%= user.name %></h2>
                    <form method="POST" action="/admin/users/<%= user.id %>">
                      <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />

                      <pre><%= JSON.stringify(user, null, 2) %></pre>

                      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="this.closest('dialog').close()">‚ùå Cancel</button>
                        <button type="submit">Ô∏èüîÑ Update</button>
                      </div>
                    </form>
                  </dialog>
                </td>
              </tr>
              <tr id="details-<%= user.id %>" style="display: none;">
                <td colspan="8" style="padding: 0; border-bottom: 1px dashed #ddd;">
                  <div style="padding: 20px; background-color: #f9f9f9;">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead>
                        <tr style="border-bottom: 1px dashed #ddd;">
                          <th style="text-align: left; padding: 8px;">üè∑Ô∏è ID</th>
                          <th style="text-align: left; padding: 8px;">üì± App</th>
                          <th style="text-align: left; padding: 8px;">üîî Alert Info</th>
                          <th style="text-align: left; padding: 8px;">üóìÔ∏è Created At</th>
                          <th style="text-align: left; padding: 8px;">Ô∏èÔ∏è‚ö°Ô∏è Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% user.apps?.forEach(app => { %>
                          <tr style="height: 100%; border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px;"><%= app.id %></td>

                            <td style="padding: 8px; display: flex; flex-direction: column;">
                              <span><%= app.name %> <%= app.is_active ? '‚úÖ' : '‚ùå' %></span>
                              <% if (app.url) { %>
                                <a href="<%= app.url %>" target="_blank">üåê <%= app.url %></a>
                              <% } %>
                              <% if (app.description) { %>
                                <span>üìù <%= app.description %></span>
                              <% } %>
                            </td>

                            <td style="padding: 8px;">
                              <div style="display: flex; flex-direction: column; gap: 5px;">
                                <span><strong>Allowed:</strong> <%= app.max_monthly_alerts_allowed %></span>
                                <div style="display: flex; gap: 5px;">
                                  <span><strong>Threshold:</strong> <%= app.user_monthly_limit_threshold || 'N/A' %></span>
                                  <span>/</span>
                                  <span><strong>Sent:</strong> <%= app.alerts_sent_this_month %></span>
                                </div>
                                <span><strong>Reset Date:</strong> <%= app.alerts_reset_date %></span>
                              </div>
                            </td>

                            <td style="padding: 8px;"><%= app.created_at %></td>

                            <td style="padding: 8px;">
                              <button class="no-style-btn" onclick="document.getElementById(`edit-user-<%= user.id %>-app-<%= app.id %>-modal`).showModal()">Ô∏èedit</button>
                              <dialog id="edit-user-<%= user.id %>-app-<%= app.id %>-modal">
                                <h2>üì± Edit App <%= app.name %></h2>
                                <form method="POST" action="/admin/users/<%= user.id %>/apps/<%= app.id %>">
                                  <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />
                                  <pre><%= JSON.stringify(app, null, 2) %></pre>
                                  <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                                    <button type="button" onclick="this.closest('dialog').close()">‚ùå Cancel</button>
                                    <button type="submit">Ô∏èüîÑ Update</button>
                                  </div>
                                </form>
                              </dialog>
                            </td>
                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>
