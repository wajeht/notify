<script>
  function toggleDetails(userId) {
    const detailsRow = document.getElementById('details-' + userId);
    if (detailsRow.style.display === 'none') {
      detailsRow.style.display = 'table-row';
    } else {
      detailsRow.style.display = 'none';
    }
  }
</script>

<div style="display: flex; flex-direction: column; gap: 20px; max-width: 100%;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <h2 style="margin: 0;">👤 Users</h2>
    <span>Data</span>
  </div>
  <div style="display: flex; flex-direction: column; gap: 20px; max-width: 100%;">
    <div style="border-style: dashed; border-radius: 5px; padding: 20px; width: 100%; display: flex; flex-direction: column; gap: 10px;">
      <div style="display: flex; flex-direction: column; gap: 5px; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">ID</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">User</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">Timezone</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">Max Apps</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">Max Exports</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">Exports Used</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">Created At</th>
              <th style="text-align: left; padding: 8px; border-bottom: 1px dashed #ddd;">Apps</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(user => { %>
              <tr>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd;"><%= user.id %></td>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd; display: flex; flex-direction: column;">
                  <span><%= user.is_admin ? '⭐️' : '' %> <%= user.username %></span>
                  <a href="mailto:<%= user.email %>"><%= user.email %></a>
                </td>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd;"><%= user.timezone %></td>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd;"><%= user.max_apps_allowed %></td>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd;"><%= user.max_export_count_allowed %></td>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd;"><%= user.export_count %></td>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd;"><%= user.created_at %></td>
                <td style="padding: 8px; border-bottom: 1px dashed #ddd;"><button class="no-style-btn" onclick="toggleDetails(<%= user.id %>)">view</button></td>
              </tr>
              <tr id="details-<%= user.id %>" style="display: none;">
                <td colspan="8" style="padding: 0; border-bottom: 1px dashed #ddd;">
                  <div style="padding: 20px; background-color: #f9f9f9;">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead>
                        <tr>
                          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">ID</th>
                          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">App</th>
                          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Alert Info</th>
                          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Created At</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% user.apps?.forEach(app => { %>
                          <tr style="height: 100%; border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px;"><%= app.id %></td>
                            <td style="padding: 8px; display: flex; flex-direction: column;">
                              <span><%= app.name %> <%= app.is_active ? '✅' : '❌' %></span>
                              <% if (app.url) { %>
                                <a href="<%= app.url %>" target="_blank"><%= app.url %></a>
                              <% } %>
                              <% if (app.description) { %>
                                <span><%= app.description %></span>
                              <% } %>
                            </td>
                            <td style="padding: 8px;">
                              <div style="display: flex; flex-direction: column; gap: 5px;">
                                <span><strong>Monthly Alerts Allowed:</strong> <%= app.max_monthly_alerts_allowed %></span>
                                <span><strong>Monthly Limit Threshold:</strong> <%= app.user_monthly_limit_threshold || 'N/A' %></span>
                                <span><strong>Alerts Sent This Month:</strong> <%= app.alerts_sent_this_month %></span>
                                <span><strong>Alerts Reset Date:</strong> <%= app.alerts_reset_date %></span>
                              </div>
                            </td>
                            <td style="padding: 8px;"><%= app.created_at %></td>
                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
